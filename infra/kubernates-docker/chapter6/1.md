---
description: 컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커
---

# 6.1 컨테이너 인프라 환경 모니터링하기

`bpytop` 명령 실행을 통해 화면에서 리소스의 상태 및 문제가 될 가능성이 있는 정보를 한눈에 파악할 수 있다.

그러나 `bpytop`은 현재 노드에 대한 정보를 보여줄 뿐, 다수의 노드로 구성된 클러스터 정보를 모두 표현하기는 어렵다. 그래서 이러한 정보를 수집하고 분류해서 따로 저장해야 한다. 거의 모든 모니터링 도구는 **수집 → 통합 → 시각화** 구조로 되어 있다.

모니터링 데이터를 프로메테우스로 **수집**하고, 수집한 정보를 한곳에 모아(**통합**), 그라파나로 **시각화**한다.

## 1. 모니터링 도구 선택하기

프로메테우스와 그라파나의 혼합 구조를 사용하는 이유

1. **비용** : 모니터링 대상마다 라이센스 관련 비용이 발생하고,, 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용이 발생한다.
2. **보안** : 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링한다. 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우에는 사용하기 어렵다.

### 데이터 수집과 통합 도구

**프로메테우스 (Prometheus)**

- 오픈 소스
- 시계열 데이터베이스를 내장하고 있다.
- 자체적인 질의 페이지 외에 시각화 기능은 없으나, 그라파나와 연계하면 현업에서 사용할 수 있는 시각화 기능을 제공할 수 있다.
- 중앙 서버에서 에이전트의 데이터를 수집하는 풀(Pull) 방식을 사용 → 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집해 모니터링할 수 있다.
- 에이전트를 통해 내부 메트릭을 외부로 노출하기 때문에 사용자가 수집 대상에 접속할 수만 있다면 개인 컴퓨터에서도 메트릭을 가져올 수 있다. → 모니터링과 관련된 개발을 하기 편하다.
- 일회성으로 모니터링 대상에 대한 세부적인 메트릭도 간단하게 웹 브라우저로 확인할 수 있다.
- 사용자 층이 넚고, 관련 자료가 많으며, 각종 대시보드 도구나 메신저 등이 프로메테우스와의 연계를 지원한다. → 직접 모니터링 시스템을 구축할 때 좋다.

**데이터독 (Datadog)**

- 서비스형 소프트웨어(Saas)
- 웹 사이트에서 모니터링 대상을 관리할 수 있고, 쿠버네티스를 비롯해 여러 클라우드 서비스나 애플리케이션과 연결이 쉬우므로 관리 부담이 적다.
- 모니터링 대상마다 요금을 부과하기 때문에 모니터링 대상이 늘면 비용이 커진다.

**뉴 렐릭 (New Relic)**

- 서비스형 소프트웨어
- 애플리케이션 성능 모니터링(APM, Application Performance Monitoring)에 특화 (vs. 데이터 독)
- 모니터링 대상이 많을수록 비용이 커진다.

**인플럭스DB (InfluxDB)**

- 3가지 유형
  1. 무료버전
     - 프로메테우스와 유사
     - 인플럭스DB가 쓰기 성능이 더 뛰어나 대량의 이벤트를 모니터링하는 데 좀 더 적합하다.
  2. 엔터프라이즈 버전
     - 설치형
     - 프로메테우스에서 부족한 부분인 고가용성을 위한 분산 저장을 좀 더 쉽게 구성할 수 있는 기능을 제공한다.
  3. 서비스형 소프트웨어(클라우드)
- 상대적으로 구성이 어렵다. (vs. 프로메테우스)

{% hint style="info" %}
**메트릭**

- 현재 시스템의 상태를 알 수 있는 측정값
- 2가지 상태로 구분한다.
  1. 시스템 메트릭 : 파드 같은 오브젝트에서 측정되는 CPU와 메모리 사용량을 나타냄.
  2. 서비스 메트릭 : HTTP 상태 코드 같은 서비스 상태를 나타내는 지표

{% endhint %}

{% hint style="info" %}
**시계열 데이터베이스**

- 시간을 축(키)으로 시간의 흐름에 따라 발생하는 데이터를 저장하는 데 최적화된 데이터베이스
- 프로메테우스의 시계열 데이터베이스에 쿠버네티스와 노드에서 공개하는 메트릭을 저장하고, 이를 효과적으로 조합해 사용자가 원하는 모니터링을 구성한다.

{% endhint %}

### 데이터 시각화 도구

**그라파나 (Grafana)**

- 특정 소프트웨어에 종속되지 않은 독립적인 시각화 도구
- 다양한 수집 도구 및 데이터베이스들과 연계를 지원한다.
- 플러그인과 대시보드의 공유가 매우 활발해 필요에 따라 적절히 선택해 사용하면 된다.
- 오픈 소스
- 설치형, 서비스형

**키바나 (Kibana)**

- 엘라스틱에서 만든 시각화 도구
- 엘라스틱서치에 적재된 데이터를 시각화하거나 검색하는데 사용하고, 이러한 데이터를 분석할 때도 사용한다.
- 엘라스틱서치의 데이터만을 시각화 가능 → 프로메테우스의 시계열 데이터를 **메트릭비트(Metricbeat)**라는 도구로 엘라스틱서치에 전달해야 한다.
- 시각화 기능이 매우 강력 → 시각화를 중점적으로 다루는 경우에 사용하면 좋다.

**크로노그래프 (Chronograf)**

- 오픈소스
- 설치형, 서비스형
- 인플럭스DB만 시각화 가능

## 2. 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

쿠버네티스 노드는 kubelet을 통해 파드를 관리하며, 파드의 CPU나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet에 내장된 **cAdvisor**를 사용한다. **cAdvisor**는 구글이 만든 컨테이너 메트릭 수집 도구로, 쿠버네티스 클러스터 위에 배포된 여러 컨테이너가 사용하는 메트릭 정보를 수집한 후 이를 가공해서 kubelet에 전달하는 역할을 한다. 하지만 외부에서 데이터를 모아서 표현해주는 도구가 없다면 의미없다.

### 리소스 메트릭 파이프라인

메트릭 데이터를 수집하는 목적으로 메트릭 서버를 설치해 HPA와 같은 기능을 구현하고, 쿠버네티스 대시보드를 설치해 현재 상태를 확인할 수도 있다. 이렇게 메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것을 **리소스 메트릭 파이프라인**이라고 한다.

### 완전한 모니터링 파이프라인

하지만 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 출력된다. 그래서 메트릭 데이터를 저장 공간에 따로 저장하는 **완전한 모니터링 파이프라인**으로 구축하기를 권장한다. 이 설계 방식을 반영한 도구가 프로메테우스이다.

완전한 모니터링 파이프라인으로 구성한 프로메테우스는 여러 수집 대상이 공개하는 메트릭 데이터를 모아 시계열 데이터베이스에 저장한다. 누적된 메트릭 데이터(영속적인 데이터)로는 쿠버네티스 인프라의 상태 변화를 파악할 수 있고, 적절한 위험 감지 및 조치를 취할 수 있다.
