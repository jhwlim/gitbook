---
description: 컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커
---

# 6.2 프로메테우스로 모니터링 데이터 수집과 통합하기

### 프로메테우스 오브젝트

**프로메테우스 서버 (prometheus-server)**

- 프로메테우스의 주요 기능을 수행하는 요소
- 역할
    1. 수집기 : 노드 익스포터 외 여러 대상에서 공개된 메트릭을 수집해 온다. (by 서비스 디스커버리)
    2. 시계열 데이터베이스 : 수집한 시계열 메트릭 데이터를 저장한다.
    3. 웹 UI : 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있다.

**노드 익스포터 (node-exporter)**

- 노드의 시스템 메트릭 정보를 HTTP로 공개한다.
- 설치된 노드에서 특정 파일들을 읽고, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환 후에 노드 익스포터에서 HTTP 서버로 공개한다.
- 공개된 내용을 프로메테우스 서버에서 수집해 간다.

**쿠버 스테이트 메트릭 (kube-state-metrics)**

- API 서버
- 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개한다.

**얼럿매니저 (alertmanager)**

- 프로메테우스에 경보(alert) 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능을 제공한다.
- 프로메테우스 서버에서 주기적으로 경보를 보낼 대상을 감시해 싯템을 안정적으로 운영할 수 있게 한다.

**푸시게이트웨이 (pushgateway)**

- 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개한다.
- 일반적으로 짧은 시간 동안 실행되고 종료되는 배치성 프로그램의 메트릭을 저장하거나 외부망에서 접근할 수 없는 내부 시스템의 메트릭을 프록시 형태로 제공하는 용도로 사용한다.

## 1. 헬름으로 프로메테우스 설치하기

### 헬름으로 프로메테우스 설치하기

헬름과 MetalLB 구성 필요

```sh
# 1. 프로메테우스 설치를 위해 필요한 사전 구성
~/_Book_k8sInfra/ch6/6.2.1/prometheus-server-preconfig.sh

# 2. 프로메테우스 오브젝트 (프로메테우스 서버, 노드 익스포터, 쿠버 스테이트 메트릭) 설치
~/_Book_k8sInfra/ch6/6.2.1/prometheus-install.sh

# 3. 프로메테우스 서버, 노드 익스포터, 쿠버 스테이트 메트릭 설치되었는지 확인
kubectl get pods --selector=app=prometheus

# 4. 프로메테우스 서버에서 제공하는 웹 UI로 접속하기 위한 프로메테우스 서비스 IP 주소 확인하기 (EXTERNAL-IP)
kubectl get service prometheus-server
```

위에서 확인한 서비스 IP 주소를 웹 브라우저에 입력해 프로메테우스 웹 UI에 접속할 수 있다.

## 2. 프로메테우스의 웹 UI 다루기

p433~437 참고

## 3. 서비스 디스커버리로 수집 대상 가져오기

프로메테우스는 수집 대상을 자동으로 인식하고 필요한 정보를 수집한다.

정보를 수집하려면 일반적으로 에이전트를 설정해야 하지만, 쿠버네티스는 사용자가 에이전트에 추가로 입력할 필요 없이 자동으로 메트릭을 수집할 수 있다.

**서비스 디스커버리**

- 프로메테우스 서버가 수집 대상을 가져오는 방법
- 동작 순서
    1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어온다.
    2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청한다.
    3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집한다.
- 프로메테우스 서버와 API 서버가 주기적으로 데이터를 주고받아 수집 대상을 업데이트하고, 수집 대상에서 공개되는 메트릭을 자동으로 수집한다.
- 2가지 경로
    1. cAdvisor : 쿠버네티스 API 서버에 직접 연결돼 메트릭을 수집한다.
    2. 에이전트(익스포터) : API 서버가 경로를 알려 주어 메트릭을 수집한다.

### cAdvisor

cAdvisor의 메트릭이 API 서버를 통해 노출되면 프로메테우스 서버가 쉽게 수집하도록 변환하는 과정을 거친다.

cAdvisor는 각 노드에 컨테이너 시스템 정보를 담고 있는 특정 파일들을 읽어 들여 메트릭을 수집한다. 그리고 프로메테우스가 수집할 수 있도록 컨테이너 메트릭을 프로메테우스의 메트릭으로 변환해 공개한다.

### 익스포터

사전 준비 작업 2가지

1. API 서버에서 등록돼 경로를 알 수 있게 해야 한다.
2. 익스포터가 데이터를 프로메테우스 타입으로 노출해야 한다.

메트릭을 공개하는 방법

1. 프로그래밍 언어의 프로메테우스 SDK를 사용해 직접 메트릭을 공개하도록 작성하는 방법
2. 이미 만들어 둔 익스포터를 사용해 메트릭을 공개하는 방법

{% hint style="info" %}
**멀티 컨테이너 패턴**

파드 내부에 컨테이너 여러 개를 구성하는 방법

- 사이드카 (Sidecar) : 메인 컨테이너의 기능을 확장하거나 기능을 향상하고자 할 때 추가하는 패턴
- 앰배서더 (Ambassador) 
    - 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태
    - 세부적인 외부 접근이나 방법은 앰배서더 컨테이너에 위임한다.
    - 주로 프록시 컨테이너를 구성해 외부의 접근을 제어하고 내부 자원을 보호하는 구성이 앰배서더 패턴에 속한다.
- 어댑터 (Adapter) : 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태

{% endhint %}

{% hint style="info" %}
**다양한 종류의 프로메테우스 익스포터**

프로메테우스는 대상을 모니터링하기 위해 다양한 형태의 익스포터를 사용한다.

- 데이터베이스 : ES, MongoDB, MySQL
- 메시징 시스템 : Kafka, NATS, MQTT, RabbitMQ
- 스토리지 : Ceph, Gluster, GPFS, NetApp E-Series
- 외부 모니터링 시스템 : AWS CloudWatch, Google Stackdriver(Operation Suite), Azure Monitor, JMX

{% endhint %}

## 4. 노드 익스포터로 쿠버네티스 노드 메트릭 수집하기

### 노드 익스포터

쿠버네티스 노드의 상태 값을 메트릭으로 추출하는 데 특화돼 있다.

노드의 `/proc`과 `/sys`에 있는 값을 메트릭으로 노출하도록 구현돼 있다.
- `/proc`
    - 리눅스 운영 체제에서 구동 중인 프로세스들의 정보를 파일 시스템 형태로 연결한 디렉터리
    - 모니터링 도구는 이 디렉터리를 통해 시스템에서 구동 중인 프로세스의 정보나 상태, 자원 사용량 등을 알 수 있다.
- `/sys`
    - 저장 장치, 네트워크 장치, 입출력 장치 같은 각종 장치를 운영 체제에서 사용할 수 있도록 파일 시스템 형태로 연결한 디렉터리
    - 모니터링 도구는 이 디렉터리를 시스템 장치의 상태 정보를 수집하는 데 사용한다.

노드 익스포터를 실행하기 위해서 쿠버네티스 노드마다 1개씩 배포할 수 있는 데몬셋으로 구현돼 배포된다.

각 쿠버네티스 노드의 `/proc`, `/sys`에 있는 파일들을 읽어서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환한다. 그리고 변환한 메트릭을 HTTP 서버를 통해 `/metrics` 주소로 공개한다.

## 5. 쿠버 스테이트 메트릭으로 쿠버네티스 클러스터 메트릭 수집하기

### 쿠버 스테이트 메트릭

쿠버네티스 상태를 보여주는 메트릭

쿠버네티스 상태에 관한 정보를 가지고 와서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환하고, 변환한 메트릭을 HTTP 서버를 통해 `/metrics` 주소로 공개하는 부분은 노드 익스포터와 동일하다.

그러나 각 노드의 특정 디렉터리를 마운트해서 사용하지 않고, 이미 API 서버에 모인 값들을 수집한다는 점에서 차이가 있다.
