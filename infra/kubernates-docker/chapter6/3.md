---
description: 컨테이너 인프라 환경 구축을 위한 쿠버네티스/도커
---

# 6.3 PromQL로 메트릭 데이터 추출하기

## 1. 메트릭 데이터의 구조

### 메트릭 값의 종류

카운터 (Counter)

- 누적된 값을 표현하는 데 사용하는 메트릭 타입
- 카운터에 누적된 값으로 구간별로 변화율을 파악해 해당 값이 어느 정도로 추세로 증가하는지 알 수 있다.
- 이벤트나 오류 등이 급증하는 구간을 파악하는데 적합하다.
- 특정 순간의 데이터를 표현하는 데는 적합하지 않다.
- 값이 얼마만큼 변했는지 변화율을 주로 확인한다.

게이지 (Gauge)

- 특정 시점의 값을 표현하는 데 사용하는 메트릭 타입
- 시점별로 증가나 감소를 모두 표현할 수 있다.
- CPU 온도나 메모리 사용량 등

히스토그램 (Histogram)

- 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도를 측정한다.
- 버킷 : 익스포터를 구현하는 단계에서 정의한 구간

서머리 (Summary)

- 구간 내에 있는 메트릭 값의 빈도를 측정한다.

### 메트릭 레이블

- 모든 메트릭 데이터는 하나 이상의 레이블을 가진다.
- 메트릭 데이터의 다양한 내용을 표현하는 유일한 방법
- 제공하고 싶은 다수의 내용을 key-value 형태로 넣는다.
- 메트릭 데이터에 포함된 레이블로 원하는 레이블을 검색하고 선택적으로 추출할 수 있다.

### 메트릭 레이블 매처

레이블 매치 : 메트릭 레이블에 조건을 줘서 검색하는 방법

조건 기호

- `=` : 조건에 넣은 값과 레이블 값이 같은 메트릭을 보여준다.
- `!=` : 조건에 넣은 값과 레이블 값이 다른 메트릭을 보여준다.
- `=~` : 조건에 넣은 정규 표현식에 해당하는 메트릭을 보여준다.
- `!~` : 조건에 넣은 정규 표현식에 해당하지 않는 메트릭을 보여준다.

## 2. PromQL 연산자

### 비교 연산자

- 비교대상이 숫자
- 메트릭 값을 비교해 조건에 해당하는 값을 가진 대상을 검색한다.
- 주로 수집 대상의 상태를 파악하는 데 사용한다.
- 예 : `==`, `!=`, `>`, `<`, `>=`, `<=`

### 논리 연산자

- 범위 지정
- 연산자 앞뒤로 입력되는 PromQL 표현식 레이블의 키와 값을 기준으로 조건 연산을 수행해 값을 반환한다.
- 예 : `and`, `or`, `unless`(차집합)

### 산술 연산자

- 사칙연산(`+`, `-`, `*`, `/`), 나머지(`%`), 지수(`^`) 같은 연산자
- 검색된 메트릭의 값을 사용자가 원하는 형태로 바꿔 준다.
- 주로 수치 단위를 변경하는 데 사용한다.

### 집계 연산자

- 수집된 메트릭을 종합하고 분석하는 연산자
- 메트릭의 값을 좀 더 의미 있는 데이터로 정리한다.
- 검색된 메트릭 값을 종합해 유용한 형태로 변환한다.
- 수집된 값에서 총합, 평균, 계측된 수 등을 바로 파악할 때 사용한다.
- 다른 연산자에 존재하지 않는 분류와 관련된 `by`(그룹화), `without`(제외) 등의 추가 옵션을 제공한다.
- 예 : `avg`, `sum`, `count`

## 3. PromQL 데이터 타입

- 레인지 벡터 : 구간이 있는 PromQL 데이터 타입
- 인스턴트 벡터 : 특정 시점에 대한 메트릭 값만을 가지는 PromQL 데이터 타입
- 스칼라 타입 : 실수 값을 표현
- 스트링 타입 : 문자열을 표현

### 시계열 메트릭 데이터로 그래프 그리기

```
node_cput_seconds_total{mode="idle", kubernets_node="w3-k8s"}[5m]
```

- `@` 뒤에 표시되는 숫자는 유닉스 시간

{% hint style="info" %}

프로메테우스의 기본 수집 주기는 60초

{% endhint %}

## 4. PromQL 함수

대표적인 함수

- 연산 함수
    - 수학 연산에 사용
    - 예 : abs(절댓값), ceil(올림), floor(내림), round(반올림), predict_linear(예측값) 등
- 변환 함수
    - 데이터 타입 간 변환에 사용
    - 예 : scalar(스칼라로 변환), vector(벡터로 변환), rate(변화율), irate(순간 변화율) 등
- 집계 함수
    - 수집된 레인지 벡터의 데이터 집계를 위해 사용
    - 예 : avg_over_time(평균), sum_over_time(합계), count_over_time(계수) 등

### 변화율을 나타내는 rate

수집한 값들의 변화율을 구할 때 사용한다.

주로 값이 증가하는 카운터 형식의 메트릭에 사용되며, 지정된 구간이 얼마나 빠르게 변화했는지 알기 위한 지표로 사용된다.

```
rate(node_cpu_seconds_total{mode="idle", kubernetes_node="w2-k8s"}[5m])
```

{% hint style="info" %}
**프로메테우스에서 제공하는 그래프의 단점**

- 변화율 값을 정확하게 표시하지 못한다.
- 제한이 많은 꺾은선 그래프로 표시돼 추이 변화를 파악하기 어렵다.
- 하나의 패널로 구성돼 여러 가지의 PromQL 쿼리를 비교할 수 없다.

따라서 프로메테우스에서 제공하는 그래프는 변화율을 보기에 적합하지 않다.

{% endhint %}

### 순간변화율을 나타내는 irate

irate는 구간 종료 바로 전 값과 구간 종료 값의 차이에 대한 변화율을 나타낸다.

rate는 구간 시작 값과 구간 종료 값의 차이에 대한 변화율을 다룬다.

따라서 구간이 매우 길면 irate의 변화율은 큰 의미가 없기 떄문에 rate 함수를 사용하는 것이 낫다.

```
irate(node_cpu_seconds_total{mode="idle", kubernetes_node="w2-k8s"}[5m])
```


### 추세를 보여주는 predict_linear

레인지 벡터로 수집된 과거 메트릭 데이터를 기반으로 앞으로 생성될 메트릭 값을 예측한다.

```
predict_linear(node_memory_MemAvailable_bytes{kubernetes_node="w1-k8s"}[5m], 60*60*1)
```

- `[5m]` : 예측에 기초가 되는 자료의 범위
- `60*60*1` : 1시간 후의 값을 예측한다.

## 5. 서머리와 히스토그램

구조적으로 서머리는 익스포터에서 이미 만들어진 값을 보여주고, 히스토그램은 요청을 받으면 이를 계산해서 보여준다.

### 서머리

서머리는 이미 공개된 메트릭 값을 조회하면 바로 확인할 수 있다.

```
prometheus_target_interval_length_seconds
```

### 히스토그램

히스토그램은 쿼리 입력기에서 쿼리를 보내면 그때서야 내부 계산식을 통해 히스토그램 메트릭을 생성한다.

```
histogram_quantile(0.99, rate(apiserver_request_duration_seconds_bucket[5m]))
```

### 히스토그램에 연산자 추가하기

히스토그램에 연산자를 추가하면 함수를 추가할 때보다 더 유용한 정보를 검출할 수도 있다.

```
histogram_quantile(0.99, sum(rate(apiserver_request_duration_seconds_bucket[5m])) by (le))
```