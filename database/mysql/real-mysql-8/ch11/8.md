---
description: Real MySQL 8.0
---

# 8. 쿼리 성능 테스트

간단하게 쿼리의 성능을 판단해보기 위해서는 어떠한 부분을 고려해야 하고, 어떤 영향 요소가 있는지 살펴본다.

## 1. 쿼리의 성능에 영향을 미치는 요소

### (1) 운영체제의 캐시

MySQL 서버는 운영체제의 파일 시스템 관련 기능(시스템 콜)을 이용해 데이터 파일을 읽어온다.

그런데 일반적으로 대부분의 운영체제는 한 번 읽은 데이터는 운영체제가 관리하는 별도의 캐시 영역에 보관해 뒀다가 다시 해당 데이터가 요청되면 디스크를 읽지 않고 캐시의 내용을 바로 MySQL 서버로 반환한다.

- InnoDB 스토리지 엔진은 일반적으로 파일 시스템의 캐시나 버퍼를 거치지 않고 Direct I/O를 사용하므로, 운영체제의 캐시가 그다지 큰 영향을 미치지 않는다.
- MyISAM 스토리지 엔진은 운영체제의 캐시에 대한 의존도가 높기 때문에, 운영체제의 캐시에 따라 성능의 차이가 큰 편이다.

운영체제가 관리하는 캐시나 버퍼는 공용 공간이기 때문에, MySQL 서버와 같은 응용 프로그램이 종료된다고 해도 여전히 남아있을 수 있다. 그래서 운영체제가 가지고 있는 캐시나 버퍼가 전혀 없는 상태에서 쿼리의 성능을 테스트하려면 다음과 같이 운영체제의 캐시 삭제 명령을 실행하고 테스트하는 것이 좋다.

```bash
-- 캐시나 버퍼의 내용을 디스크와 동기화 한다.
sync

-- 운영체제에 포함된 캐시의 내용을 초기화한다.
echo 3 > /proc/sys/vm/drop_caches
```

### (2) MySQL 서버의 버퍼 풀(InnoDB 버퍼 풀과 MyISAM의 키 캐시)

운영체제의 버퍼나 캐시와 마찬가지로 MySQL 서버에서도 데이터 파일의 내용을 페이지(또는 블록) 단위로 캐시하는 기능을 제공한다.
    
- InnoDB 스트리지 엔진이 관리하는 캐시 : 버퍼 풀
    - 인덱스 페이지는 물론이고, 데이터 페이지까지 캐시하며, 쓰기 작업을 위한 버퍼링 작업까지 겸해서 처리한다.
- MyISAM 스토리지 엔진이 관리하는 캐시 : 키 캐시
    - 인덱스 데이터에 대해서만 캐시 기능을 제공한다.
    - 주로 읽기를 위한 캐시 역할을 수행하며, 제한적으로 인덱스 변경만을 위한 버퍼 역할을 수행한다.
    - 결국 인덱스를 제외한 테이블 데이터는 모두 운영체제의 캐시에 의존할 수 밖에 없다.

MySQL 서버가 한번 시작되면 InnoDB의 버퍼 풀과 MyISAM의 키 캐시의 내용을 강제로 삭제할 수 있는 방법이 없다. MySQL 서버에 포함된 키 캐시나 버퍼 풀을 초기화하려면 MySQL 서버를 재시작해야 한다.

- InnoDB의 버퍼풀은 MySQL 서버가 종료될 때 자동으로 덤프됐다가 다시 시작될 때 자동으로 적재되기 때문에, `innodb_buffer_pool_load_at_startup` 시스템 변수를 OFF로 설정한 후 재시작해야 한다.

### (3) 독립된 MySQL 서버

MySQL 서버가 기동 중인 장비에 웹 서버나 다른 배치용 프로그램이 실행되고 있다면 테스트하려는 쿼리의 성능이 영향을 받게 된다.

마찬가지로 서버뿐만 아니라 테스트 쿼리를 실행하는 클라이언트 프로그램이나 네트워크의 영향 요소도 고려해야 한다.

MySQL 서버가 설치된 서버에 직접 로그인해서 테스트해볼 수 있다면 이러한 요소를 쉽게 배제할 수 있을 것이다.

### (4) 쿼리 테스트 횟수

실제 쿼리의 성능 테시트를 MySQL 서버의 상태가 워밍업된 상태에서 진행할지 콜드 상태에서 진행할지도 고려해야 한다.

- 워밍업 상태 : 캐시나 버퍼가 필요한 데이터로 준비된 상태
- 콜드 상태 : 캐시나 버퍼가 모두 초기화된 상태

일반적으로 쿼리의 성능 테시트는 콜드 상태가 아닌 워밍업된 상태를 가정하고 테스트하는 편이다.

간단한 쿼리의 성능 비교 테스트에서는 특별히 영향을 미칠 만한 프로세스나 다른 쿼리가 실행되고 있는지 확인한 후, 테스트를 진행하면 충분할 것이다.

쿼리를 한 번 실행해서 나온 결과를 그대로 신뢰해서는 안된다. 테스트하려는 쿼리를 번갈아 가면서 6~7번 정도 실행한 후, 처음 한두번의 결과는 버리고 나머지 결과의 평균값을 기준으로 비교하는 것이 좋다.
