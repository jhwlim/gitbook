---
description: Real MySQL 8.0
---

# 6. 복제 토폴로지

MySQL 5.7 버전부터 멀티 소스 복제 기능 도입됨.

## 1. 싱글 레플리카 복제 구성

- 하나의 소스 서버에 하나의 레플리카 서버만 연결돼 있는 복제 형태 (가장 기본적인 형태)
- 보통 애플리케이션 서버는 소스 서버에만 직접적으로 접근해 사용하고, 레플리카 서버에는 접근하지 않는다.
- 레플리카 서버는 소스 서버에서 장애가 발생했을 때 사용될 수 있는 예비 서버 및 데이터 백업을 위한 용도로 많이 사용된다.
- 서비스와는 연관 없는 배치 작업이나 어드민 툴에서 사용되는 쿼리들은 레플리카 서버에서 실행되도록 구현돼도 무방하다.

## 2. 멀티 레플리카 복제 구성

- 하나의 소스 서버에 2개 이상의 레플리카 서버를 연결한 복제 형태
- 싱글 레플리카 복제 구성에서 추갖거인 용도를 위해 여분의 레플리카 서버가 더 필요해졌을 때 자주 사용하는 형태
- 서비스의 트래픽이 크게 증가했을 때, 보통 읽기 요청이 더 많아지므로 사용자는 멀티 레플리카 형태로 복제 구성을 전환해 읽기 요청을 분산시킬 수 있다.
- 배치나 통계, 분석 등의 여러 작업이 하나의 MySQL 서버 내에 있는 데이터에 대해 수행돼야 하는 경우에도 멀티 레플리카 형태로 복제를 구축해 용도별로 하나씩 레플리카 서버를 나눠 전용으로 사용하게 할 수도 있다.
- 레플리카 서버 한 대는 대체 서버 및 백업 수행 용도 외 최소한의 용도로만 사용되는 예비용 서버 한대를 남겨두는 것이 좋다. 레플리카 서버로 서비스 읽기 요청이 들어오는 경우, 해당 레플리카 서버는 소스 서버만큼 중요해진다.

## 3. 체인 복제 구성

- 1:M:M 구조
- 멀티 레플리카 복제 구성에서 레플리카 서버가 너무 많아 소스 서버의 성능에 악영향이 예상될 때 체인 복제 구성을 고려해볼 수 있다. 소스 서버는 레플리카 서버가 요청할 때마다 계속 바이너리 로그를 읽어서 전달해야 하는데, 만약 연결된 레플리카 서버 수가 많다면 바이너리 로그를 읽고 전달하는 작업 자체가 부하가 될 수 있다. 이때, 소스 서버가 해야 할 바이너리 로그 배포 역할을 새로운 MySQL 서버로 넘길 수 있다.
- MySQL 서버를 업그레이드하거나 장비를 일괄 교체할 때도 많이 사용된다. (p498~501 참고)
- MySQL 8.0.2 버전부터는 사용자가 별도의 설정 없이 체인 형태의 복제를 바로 구성할 수 있다.
- 또한, 체인 복제 구성을 사용할 때는 중간 계층의 서버에서 장애가 발생하는 경우, 하위 계층의 레플리카 서버들도 복제가 중단된다. → 장애 처리시 복잡도 ↑

## 4. 듀얼 소스 복제 구성

- 두 개의 MySQL 서버가 서로 소스 서버이자 레플리카 서버로 구성돼 있는 형태
- 두 MySQL 서버 모두 쓰기가 가능하다. 각 서버에서 변경한 데이터는 복제를 통해 다시 각 서버에 적용되므로 양쪽에서 쓰기가 발생하고, 두 서버는 서로 동일한 데이터를 갖게 된다.
- 목적에 따라 두 서버를 ACTIVE-PASSIVE 또는 ACTIVE-ACTIVE 형태로 사용할 수 있다.
  - ACTIVE-PASSIVE
    - 하나의 MySQL 서버에서만 쓰기 작업이 수행되는 형태
    - 쓰기 작업이 수행되고 있는 서버에서 문제 발생 시 별도의 설정 변경 없이 바로 예비용 서버로 쓰기 작업을 전환할 수 있다.
    - 한 서버에서 다른 서버로 바로 쓰기가 전환될 수 있는 환경이 필요한 경우에 주로 사용
  - ACTIVE-ACTIVE
    - 두 서버 모두에 쓰기 작업을 수행하는 형태
    - 지리적으로 매우 떨어진 위치에서 유입되는 쓰기 요청도 원활하게 처리하기 위해 주로 사용
    - 거리상 떨어져 있기 때문에 복제를 통해 다른 지역의 MySQL 서버로 부터 넘어온 트랜잭션이 적용되기까지 다소 시간이 걸릴 수 있다. → 두 MySQL 서버는 서로 일관되지 않은 데이터를 가질 수 있다.
- 다음과 같은 부분에서 문제가 발생할 수 있기 때문에 주의해야 한다.
  - 동일한 데이터를 각 서버에서 변경 : MySQL 서버에서 처리되는 속도에 따라 실제 쿼리가 유입된 순서와는 다른 순서로 데이터가 최종적으로 업데이트될 수 있다.
  - 테이블에서 Auto-Increment 키 사용 : 동일한 Auto-Increment 키 값을 갖게 될 수 있고, 이로 인해 중복 키 에러가 발생할 수 있다.

{% hint style="warning" %}

듀얼 소스 구성을 포함해서 멀티 소스 복제 구성은 쓰기 처리시, 모든 소스 서버들은 다른 소스 서버의 변경 내용들을 복제를 통해 자신에게도 똑같이 실행해야 하기 때문에 **쓰기 확장 효과는 크지 않다.**

오히려 여러 소스 서버에서 동시에 변경이 발생하면 위에서 설명한 트랜잭션 충돌로 인해 롤백이나 복제 멈춤 현상 등 역효과가 많은 편으로, 실제로 많이 사용되지 않는 편이다.

만약 쓰기 성능의 확장이 필요하다면 데이터베이스 서버를 샤딩하는 방법을 권장한다.

{% endhint %}

## 5. 멀티 소스 복제 구성

- 하나의 레플리카 서버가 둘 이상의 소스 서버를 갖는 형태
- MySQL 5.7.6 버전에서 처음 도입됨.
- 목적
  - 여러 MySQL 서버에 존재하는 각기 다른 데이터를 하나의 MySQL 서버로 통합 (분석용)
  - 여러 MySQL 서버에 샤딩돼 있는 테이블 데이터를 하나의 테이블로 통합 (MySQL 서버 수를 줄이기 위해)
  - 여러 MySQL 서버의 데이터들을 모아 하나의 MySQL 서버에서 백업을 수행

{% hint style="success" %}

각 소스 서버로부터 유입되는 변경 이벤트들이 레플리카 서버로 복재됐을 때, 서로 충돌을 일으킬 만한 부분이 없는지 사전에 충분한 검토 필요

{% endhint %}

{% hint style="success" %}

멀티 소스 복제의 레플리카 서버는 각 소스 서버들의 대체 서버로 사용하기에는 어려움이 있으므로 장애 대비용 레플리카 서버는 멀티 소스가 아닌 각 소스 서버와 일대일 복제로 연결된 별도의 서버로 구축하는 것이 좋다.

{% endhint %}

### (1) 멀티 소스 복제 동작

MySQL의 멀티 소스 복제에서 레플리카 서버는 자신과 연결된 소스 서버들의 변경 이벤트들을 동시에, 병렬로 동기화한다. 이는 각 소스 서버들에 대한 복제가 독립적으로 처리되는 것을 의미하며, 각각의 독립된 복제 처리를 **채널**이라고 한다. 각 복제 채널은 개별적인 레플리케이션 I/O 스레드, 릴레이 로그, 레플리케이션 SQL 스레디를 가지며, 채널의 이름은 어느 소스 서버와의 복제 연결인지를 구변할 수 있는 식별자 역할을 한다.

멀티 소스 복제에서도 단일 소스 복제와 동일하게 GTID 설정이나 반동기 복제 방식 설정 등이 모두 가능하며, 각 복제 채널별로 멀티 스레드로 복제를 처리하거나 소스 서버의 변경 이벤트를 필터링하도록 설정하는 것도 가능하다.

복제 관련 명령어는 p505 참고

### (2) 멀티 소스 복제 구축

복제를 연결하기 위해 소스 서버들의 백업 데이터를 레플리카 서버로 적재해야 하는데, 기존과 달리 여러 대의 소스 서버의 백업 데이터를 가져와야 하므로 이 부분의 작업이 조금 번거롭고 까다롭게 느껴질 수 있다.

멀티 소스 복제로 연결할 소스 서버들 중에서 두 개 이상의 소스 서버에서 데이터를 가져와야 한다면 mysql 데이터베이스와 같이 공통으로 가지고 있는 데이터베이스와 InnoDB의 시스템 테이블 스페이스의 충돌과 병합을 고려해야 한다.

여러 소스 서버의 데이터를 가져와 레플리카 서버의 초기 데이터로 적재할 때는 mysqldump와 XtraBackup을 적절히 혼합해서 사용하는 것이 제일 손쉬운 방법이다.

- mysqldump (논리 수준의 백업 도구)
  - InnoDB의 시스템 테이블 스페이스를 물리적으로 백업하는 것이 아니기 때문에, 데이터를 적재할 때 병합과 관련된 문제 발생 X
  - 차례대로 백업된 데이터를 레플리카 서버에 적재해도 크게 문제 X
  - mysql 데이터베이스에 저장되는 스토어드 프로시저나 함수, 그리고 유저 정보나 권한과 관련된 테이블은 중복될 가능성이 있지만 레코드 수가 많지 않기 때문에 수작업으로 조정 가능함.
  - 백업된 데이터가 매우 크다면 데이터 백업과 적재에 상당히 오랜 시간이 소요될 수 있다.
- XtraBackup (물리 수준의 백업 도구)
  - 대용량의 데이터베이스를 빠르게 레플리카 서버로 가져올 수 있다.
  - InnoDB 스토리지 엔진과 같은 테이블은 시스템 테이블 스페이스에 테이블의 정보를 따로 보관한다.
  - 시스템 테이블 스페이스를 포함해서 MySQL 서버의 모든 데이터 파일들을 그대로 복사해서 복구하게 된다.
  - 만약 두 소스 서버에서 데이터를 가져와야 한다면, 시스템 테이블 스페이스를 문제없이 하나로 병합할 수 있는 방법은 없다.

상세 케이스 및 예시는 p507~514 참고
