---
description: Real MySQL 8.0
---

# 2. MySQL 엔진의 잠금

MySQL에서 사용되는 잠금은 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다.

- MySQL 엔진 레벨의 잠금
    - 모든 스토리지 엔진에 영향을 미친다.
    - 테이블 데이터 동기화를 위한 테이블 락 이외에도, 테이블의 구조를 잠그는 메타데이터 락, 그리고 사용자의 필요에 맞게 사용할 수 있는 네임드 락이라는 잠금 기능도 제공한다.
- 스토리지 엔진 레벨의 잠금
    - 스토리지 엔진 간 상호 영향을 미치지 않는다.

## 1 글로벌 락

- `FLUSH TABLES WITH READ LOCK` 명령으로 획득 가능 (테이블에 실행 중인 모든 종류의 쿼리가 완료돼야 함.)
- MySQL에서 제공하는 잠금 다운데 가장 범위가 크다. (MySQL 서버 전체)
- 일단 한 세션에서 글로벌 락을 획득하면 다른 세션에서 SELECT를 제외한 대부분의 DDL 문장이나 DML 문장을 실행하는 경우, 글로벌 락이 해제될 때까지 해당 문장이 대기 상태로 남는다.
- 작업 대상 테이블이나 데이터베이스가 다르더라도 동일하게 영향을 미친다.
- 여러 데이터베이스에 존재하는 MyISAM이나 MEMORY 테이블에 대해 mysqldump로 일관된 백업을 받아야 할 때는 글로벌 락을 사용해야 한다.

{% hint style="warning" %}

글로벌 락은 MySQL 서버의 모든 테이블에 큰 영향을 미치기 때문에 웹 서비스용으로 사용되는 MySQL 서버에서는 가급적 사용하지 않는 것이 좋다.

{% endhint %}

**백업 락**

- MySQL 8.0 버전부터는 Xtrabackup이나 Enterprise Backup과 같은 백업 툴들의 안정적인 실행을 위해 백업 락이 도입됐다.
- 특정 세션에서 백업 락을 획득하면 모든 세션에서 테이블의 스키마나 사용자의 인증 관련 정보를 변경할 수 없게 된다.
- 일반적인 테이블의 데이터 변경은 허용된다.

## 2 테이블 락

- 개별 테이블 단위로 설정되는 잠금
- 명시적 또는 묵시적으로 특정 테이블의 락을 획득할 수 있다.
    - `LOCK TABLES table_name [ READ | WRITE ]` 명령으로 명시적 테이블의 락 획득 가능
    - `UNLOCK TABLES` 명령으로 잠금 반납 가능
- 명시적으로 테이블을 잠그는 작업은 글로벌 락과 동일하게 온라인 작업에 상당한 영향을 미친다.
- 묵시적인 테이블 락은 쿼리가 실행되는 동안 자동으로 획득됐다가 쿼리가 완료된 후 자동 해제된다. (MyISAM, MEMORY 테이블)
- InnoDB 테이블의 경우 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하기 때문에 단순 데이터 변경 쿼리(DML)로 인해 묵시적인 테이블 락이 설정되지 않는다. 스키마를 변경하는 쿼리(DDL)의 경우에만 영향을 미친다.

## 3 네임드 락

- `GET_LOCK()` 함수를 이용해 임의의 문자열에 대해 잠금을 설정할 수 있다.
- 대상이 테이블이나 레코드 또는 `AUTO_INCREMENT`와 같은 데이터베이스 객체가 아니라, 단순히 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금이다.
- 자주 사용되지는 않는다.
- 많은 레코드에 대해서 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하게 사용할 수 있다.
- 배치 프로그램처럼 한꺼번에 많은 레코드를 변경하는 쿼리는 자주 데드락의 원인이 되는데, 동일 데이터를 변경하거나 참조하는 프로그램끼리 분류해서 네임드 락을 걸고 쿼리를 실행하면 문제를 해결할 수 있다.
- MySQL 8.0 버전부터는 네임드 락을 중첩해서 사용할 수 있고, 현재 세션에서 획득한 네임드 락을 한 번에 모두 해제하는 기능도 추가됐다.

## 4. 메타데이터 락

- 데이터베이스 객체(테이블, 뷰 등)의 이름이나 구조를 변경하는 경우에 획득하는 잠금
- 테이블의 이름을 변경하는 경우 자동으로 획득하는 잠금