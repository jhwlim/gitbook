---
description: Real MySQL 8.0
---

# 5. 전문 검색 인덱스

**인덱싱 알고리즘**

- 일반적으로 크지 않은 데이터 또는 이미 키워드화한 작은 값에 대한 인덱싱 알고리즘
- 대표적으로 MySQL의 B-Tree 인덱스
    - 실제 칼럼 값이 1MB이더라도 InnoDB의 경우 3072바이트까지만 잘라서 인덱스 키로 사용
    - 전체 일치 또는 좌측 일부 일치와 같은 검색만 가능
    - 전문(Full Text) 검색에서는 사용 X

**전문 검색(Full Text search) 인덱스**

- 문서 전체에 대한 분석과 검색을 위한 인덱싱 알고리즘

## 1. 인덱스 알고리즘

문서 본문의 내용에서 사용자가 검색하게 될 키워드를 분석해 내고, 빠른 검색용으로 사용할 수 있게 이러한 키워드로 인덱스를 구축한다.

키워드의 분석 및 인덱스 구축에는 여러 가지 방법이 있을 수 있다. 전문 검색 인덱스는 문서의 키워드를 인덱싱하는 기법에 따라 단어의 어근 분리과 n-gram 분석 알고리즘으로 구분할 수 있다.

MySQL 8.0 버전부터는 구분자 방식이 이미 어근 분석과 n-gram 알고리즘에 함께 포함된다.

### (1) 어근 분석 알고리즘

MySQL 서버의 전문 검색 인덱스의 색인 과정

- 불용어(Stop Word) 처리
- 어근 처리(Stemming)

**불용어 처리**

- 검색에 별 가치가 없는 단어를 모두 필터링해서 제거하는 작업
- 불용어의 개수는 많지 않기 때문에 알고리즘을 구현한 코드에 모두 상수로 정의해서 사용하는 경우가 많고, 유연성을 위해 불용어 자체를 데이터베이스화해서 사용자가 추가하거나 삭제할 수 있게 구현하는 경우도 있다.

**어근 분석**

- 검색어로 선정된 단어의 뿌리인 원형을 찾는 작업
- 각 국가의 언어가 서로 문법이 다르고, 다른 방식으로 발전해왔기 때문에 형태소 분석이나 어근 분석 또한 언어별로 방식이 모두 다르다.
    - 한글, 일본어 : MeCab
    - 서구권 언어 : Snowball (MongoDB에서 사용됨.)
- MeCab이 제대로 작동하려면, 우선 단어 사전이 필요하며, 문장을 해체해서 각 단어의 품사를 식별할 수 있는 문장의 구조 인식이 필요하다. 문장의 구조 인식을 위해서는 실제 언어의 샘플을 이용해 언어를 학습하는 과정이 필요하며, 이 과정은 상당한 시간이 필요하다.

MeCab의 단점

- MeCab은 매우 전문적인 전문 검색 알고리즘 → 많은 노력과 시간 필요
- 범용적으로 사용하기 어렵다.
- 문장을 이해하는 알고리즘

### (2) n-gram 알고리즘

단순히 키워드를 검색해내기 위한 인덱싱 알고리즘

**n-gram**

- 본문을 무조건 몇 글자씩 잘라서 인덱싱하는 방법
- 형태소 분석보다는 알고리즘이 단순하고 국가별 언어에 대한 이해와 준비 작업이 필요 없다.
- 인덱스의 크기가 상당히 크다.
- n-gram에서 *n*은 인덱싱할 키워드의 최소 글자 수를 의미한다.
- 일반적으로는 2글자 단위로 키워드를 쪼개서 인덱싱하는 2-gram(Bi-gram) 방식이 많이 사용된다.

**2-gram 알고리즘**

예시

```
To be or not to be. That is the question
```

1. 각 단어는 띄어쓰기(공백)와 마침표(`,`)를 기준으로 10개의 단어로 구분되고, 2글자씩 중첩해서 토큰으로 분리된다.

```
To -> To
be -> be
or -> or
not -> no, ot
to -> to
be -> be
That -> Th, ha, at
is -> is
the -> th, he
question -> qu, ue, es, st, ti, io, on
```

2. 구분된 각 토큰을 인덱스에 저장한다. 이때 중복된 토큰은 하나의 인덱스 엔트리로 병합되어 저장된다.

3. 이렇게 생성된 토큰들에 대해 불용어를 걸러낸다. 이때, 불용어와 동일하거나, 불용어를 포함하는 경우 걸러서 버린다.

{% hint style="info" %}

**불용어 확인하기**

```sql
SELECT * FROM information_schema.INNODB_FT_DEFAULT_STOPWORD;
```

{% endhint %}

### (3) 불용어 변경 및 삭제

위의 예시의 경우, `ti`와 `at`, `ha` 같은 토큰들은 `a`와 `i` 철자가 불용어로 등록돼 있기 때문에 모두 걸러져 버린다.

실제로 이 같은 불용어 처리는 사용자에게 도움이 되기보다는 사용자를 더 혼란스럽게 하는 기능일 수도 있다.

{% hint style="success" %}

불용어 처리 자체를 완전히 무시하거나 MySQL 서버에 내장된 불용어 대신 사용자가 직접 불용어를 등록하는 방법을 권장한다.

{% endhint %}

**불용어 처리를 무시하는 방법**

- 방법 1 : 스토리지 엔진에 관계없이 MySQL 서버의 모든 전문 검색 인덱스에 대해 불용어 완전히 제거하기
    - MySQL 서버의 설정파일(my.cnf)의 `ft_stopword_file` 시스템 변수에 빈 문자열을 설정하면 된다. (MySQL 서버 재시작 필요)
    - `ft_stopword_file=''`
- 방법 2 : InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 인덱스에 대해서만 불용어 처리 무시하기
    - `innodb_ft_enable_stopword` 시스템 변수를 `OFF`로 설정하면 된다.
    - `SET GLOBAL innodb_ft_enable_stopword=OFF`

**사용자 정의 불용어를 사용하는 방법**

- 방법 1 : 불용어 목록을 파일로 저장하기
    - MySQL 서버 설정 파일에서 파일의 경로를 설정하면 된다.
    - `ft_stopword_file='/data/my_custom_stopword.txt'`
- 방법 2 : 불용어 목록을 테이블로 저장하기 
    - InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 엔진에서만 사용 가능
    - 불용어 테이블 생성하고, `innodb_ft_server_stopword_table` 시스템 변수에 불용어 테이블을 설정하면 된다.
    - 이때, 불용어 목록을 변경한 이후 전문 검색 인덱스가 생성돼야만 변경된 불용어가 적용된다.
    - 여러 전문 검색 인덱스가 서로 다른 불용어를 사용해야 하는 경우라면 `innodb_ft_user_stopword_table` 시스템 변수를 이용하면 된다. (`innodb_ft_server_stopword_table` 시스템 변수와 사용법은 동일함.)

## 2. 전문 검색 인덱스의 가용성

전문 검색 인덱스를 사용하기 위한 조건

1. 쿼리 문장이 전문 검색을 위한 문법(`MATCH ... AGAINST ...`)을 사용
2. 테이블이 전문 검색 대상 칼럼에 대해서 전문 인덱스 보유
