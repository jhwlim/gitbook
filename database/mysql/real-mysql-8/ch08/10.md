---
description: Real MySQL 8.0
---

# 10. 외래키

InnoDB 스토리지 엔진에서만 생성 가능

외래키 제약이 설정되면 자동으로 연관되는 테이블의 칼럼에 인덱스까지 생성된다.

외래키가 제거되지 않은 상태에서는 자동으로 생성된 인덱스를 삭제할 수 없다.

**특징**

- 테이블의 변경(쓰기 잠금)이 발생하는 경우에만 잠금 경합(잠금 대기)이 발생한다.
- 외래키와 연관되지 않은 칼럼의 변경은 최대한 잠금 경함(잠금 대기)을 발생시키지 않는다.

## 1. 자식 테이블의 변경이 대기하는 경우

|작업 번호|커넥션-1|커넥션-2|비고|
|:-:|:--|:--|:--|
|1|BEGIN;|
|2|UPDATE tb_parent<br>SET fd='changed-2' WHERE id=2;||tb_parent 테이블에서 id가 2인 레코드에 대해 쓰기 잠금 획득
|3||BEGIN;|
|4||UPDATE tb_child<br>SET pid=2 WHERE id=100;|tb_child의 외래키 칼럼인 pid를 2로 변경하는 쿼리, 자식 테이블의 외래 키 칼럼의 변경은 부모 테이블의 확인 필요한데, **부모 테이블의 해당 레코드가 쓰기 잠금이 걸려 있기 때문에 쓰기 잠금이 해제될 때까지 기다린다.**
|5|ROLLBACK;|
|6||Query OK|

## 2. 부모 테이블의 변경 작업이 대기하는 경우

|작업 번호|커넥션-1|커넥션-2|비고|
|:-:|:--|:--|:--|
|1|BEGIN;|
|2|UPDATE tb_child<br>SET fd='changed-100' WHERE id=100;||부모 키 1 을 참조하는 자식 테이블의 레코드 변경 쿼리, tb_child 테이블의 레코드에 대해 쓰기 잠금 획득
|3||BEGIN;|
|4||DELETE FROM tb_parnet<br>WHERE id=1;|id가 1인 레코드 삭제 쿼리, tb_child 테이블의 레코드에 대한 쓰기 잠금이 해제될 때까지 기다려야 한다. (`ON DELETE CASCADE`)
|5|ROLLBACK;|
|6||Query OK|

{% hint style="success" %}

데이터베이스에서 외래 키를 물리적으로 생성하려면 이러한 현상으로 인한 잠금 경합까지 고려해 모델링을 진행하는 것이 좋다.

{% endhint %}

물리적으로 외래키를 생성하면 자식 테이블에 레코드가 추가되는 경우 해당 참조키가 부모 테이블에 있는지 확인하는데, 물리적인 외래키의 고려 사항은 이러한 체크를 위해 연관 테이블에 읽기 잠금을 걸어야 한다는 것이다.

또한 이렇게 잠금이 다른 테이블로 확장되면 그만큼 전체적으로 쿼리의 동시 처리에 영향을 미친다.